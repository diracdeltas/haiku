<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>haikubot</title>
    <style>
      body {
        font-size: 20px;
        -webkit-print-color-adjust: exact;
      }

      #generator * {
        font-size: 30px;
      }

      #result {
        width:484px;
        margin-top:20px;
        background:rgba(255,255,255,0.5);
      }

      #controls {
        visibility:hidden;
        margin-top: 20px;
      }

      @media print {
        * {
          -webkit-print-color-adjust: exact !important;
        }
        body {
          width: 500px;
          background: no-repeat;
        }
        [data-html2canvas-ignore='true'] {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id='generator'>
      <input size=30 data-html2canvas-ignore='true' placeholder='enter a haiku theme'>
      <button data-html2canvas-ignore='true' id='button'>generate</button>
    </div>
    <div id='result'></div>
    <div id='controls' data-html2canvas-ignore='true'>
      <button id='save'>save card</button>
      <button id='print'>print card</button>
      <button id='share'>share card</button>
    </div>
  </body>
  <script src='./html2canvas.min.js'></script>
  <script>
    const input = document.querySelector('input');
    const button = document.querySelector('#button');
    const result = document.querySelector('#result');
    const body = document.querySelector('body');
    const print = document.querySelector('#print');
    const save = document.querySelector('#save');
    const share = document.querySelector('#share');
    const controls = document.querySelector('#controls');

    if (!navigator.canShare) {
      share.style.display = 'none';
    }

    print.onclick = () => {
      window.print();
    };

    // Returns `Promise<HTMLCanvasElement>`
    const renderCanvas = () => {
      return html2canvas(body, {
        windowWidth: '515px',
        windowHeight: '700px',
        onclone: (clone) => {
          clone.body.style.backgroundRepeat = 'no-repeat';
          const result = clone.querySelector('#result');
          result.style.position = 'fixed';
          result.style.top = '20px';
          result.style.left = '15px';
        }
      });
    };

    function downloadImage(canvas) {
      const a = document.createElement('a');
      const data = canvas.toDataURL('image/jpeg', 1.0);
      a.href = data;
      a.download = `${Date.now()}.jpeg`;
      a.click();
    }

    save.onclick = () => {
      renderCanvas().then((canvas) => {
        downloadImage(canvas);
      })
    };

    function shareImage(canvas) {
      renderCanvas().then((canvas) => {
        canvas.toBlob(
          (blob) => {
            const filename = `${Date.now()}.jpeg`;
            const file = new File([blob], filename, {
              type: 'image/jpeg',
            });
            const files = [file];

            if (navigator.canShare && navigator.canShare({files})) {
              navigator.share({
                files,
                title: 'Haiku',
                text: `Haiku generated from prompt: ${input.value}`,
              })
              .then(() => console.log('Shared successfully'))
              .catch((error) => console.log('Sharing failed', error));
            } else {
              console.log(`Your system doesn't support sharing files.`);
            }
          },
          "image/jpeg",
          1.0
        );
      });
    }

    share.onclick = () => {
      renderCanvas().then((canvas) => {
        shareImage(canvas);
      });
    };

    const promptLengthMax = 200;
    const promptLengthWarningHaiku = `Words overflow prompt,
Rejected for being long,
Concision desired.`;

    button.onclick = () => {
      controls.style.visibility = 'hidden';

      const words = input.value;
      if (words.length > promptLengthMax) {
        result.innerText = promptLengthWarningHaiku;
        body.style.backgroundImage = 'none';
        body.style.backgroundColor = 'white';
        return;
      }

      const rand = Math.ceil(Math.random() * 746);
      const background = `./img/${rand}.jpg`;
      body.style.backgroundImage = `url("${background}")`;
      result.innerText = 'churning...';

      fetch(`/api?${new URLSearchParams({words})}`).then((response) => response.text()).then((text) => {
        result.innerText = text;
        if (window.location.hash === '#autosave') {
          save.style.display = 'none';
          save.onclick();
        }
        controls.style.visibility = 'visible';
      });
    };

    input.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        button.onclick();
      }
    });
  </script>
</html>
